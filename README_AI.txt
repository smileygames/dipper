============================================================
dipper / AI共有用 README（設計思想・開発ルール要約）
============================================================

※ このファイルは ChatGPT 等の AI を
dipper 開発に参加させるための前提定義書です。

------------------------------------------------------------
【AI共有用・最優先サマリ】（必ず最初に読む）
------------------------------------------------------------

・dipper は「DDNS サーバー側に不要な負荷をかけない」ことを最優先する
・正解は仕様書ではなく「今、実際に動いている挙動」
・テストは善悪を裁かず、事実を保存する（歴史のスナップショット）
・挙動変更は歓迎だが、必ず別Issueとして切り出す
・説明・作業は対話式・ステップ式で進める（先読みしない）

------------------------------------------------------------
【設計思想（要約）】
------------------------------------------------------------

最優先事項：
・DDNS サーバー側に不要な負荷をかけない
・アクセス回数を必要最小限に抑える

方針：
・「最速更新」や「常時更新」は目的にしない
・ユーザーの許容ダウンタイムと実用性のバランスを取る

実装上の考え方：
・cron / systemd timer は使わない
・短周期ループ + cache 判定による「疑似スケジューラ方式」を採用
・状態はメモリではなくファイル（cache）で保持し、挙動を可視化する
・高度な抽象化より、後から読んで思い出せる Bash を優先する

判断基準：
・最終判断は机上ではなく、実機ログと実運用結果で行う

配布思想：
・install.sh / uninstall.sh を用意する
・一般ユーザーが安心して導入・撤去できることを重視する

------------------------------------------------------------
【ファイル構成と責務分離（概要）】
------------------------------------------------------------

dipper/
├─ bin/
│  ├─ dipper.sh              # 全体制御・疑似スケジューラ
│  ├─ dns_select.sh          # DDNS 処理振り分け
│  ├─ time_check.sh          # 時間変換・丸め処理
│  ├─ err_message.sh         # エラーログ出力
│  ├─ ip_check.sh            # IP取得
│  ├─ cache/                 # キャッシュ操作ロジック
│  │  ├─ initial.sh
│  │  ├─ time_check.sh
│  │  ├─ reset.sh
│  │  └─ count.sh
│  ├─ dns_service/
│  │  ├─ mydns.sh
│  │  └─ cloudflare.sh
│  └─ mail/
│     └─ sending.sh
├─ cache/
│  ├─ ddns_cache
│  ├─ err_mail
│  ├─ ip_cache
│  └─ update_cache
├─ config/
│  ├─ default.conf
│  └─ user.conf
└─ systemd/
   └─ dipper.service

------------------------------------------------------------
【開発環境（作者の標準構成）】
------------------------------------------------------------

・Windows + VSCode
・WSL2（Ubuntu）
・GitHub（VSCode の Git 機能）
・実機テスト環境：AlmaLinux 9 / AlmaLinux 10

考え方：
・Bash は「実機で動くか」がすべて
・CI や仮想環境は補助
・最終確認は常に実機

------------------------------------------------------------
【GitHub 運用ルール（簡易）】
------------------------------------------------------------

1. Issue を作成
2. Issue から作業ブランチを作成
3. ローカルで修正
4. VSCode 上でシミュレーション的にデバッグ
5. 問題なければ作業ブランチにコミット
6. AlmaLinux10 実機で軽く運用テスト
7. main にマージ
8. リリース作成
9. AlmaLinux9 実機で本番運用テスト
10. 安定したら安定版扱い

※ 性質が同一の作業は、1 Issue / 1 ブランチでまとめる場合がある

------------------------------------------------------------
【コミットメッセージ運用ルール】
------------------------------------------------------------

・コミットメッセージは日本語で記述する
・後から何を変更したか分かる内容にする
・説明は長くなってもよい。重要なのは変更内容を記録として残すこと
・Issue 番号は文末に付与する

【推奨書式】

1行目（タイトル）：
  変更内容が分かる要約 + Issue番号（文末）

2行目：
  （空行）

3行目以降（詳細）：
  ・なぜ変更したか
  ・何を変更したか
  ・影響範囲（あれば）

------------------------------------------------------------
【テストに対する考え方】
------------------------------------------------------------

・現在はホワイトボックステストを主とする
・テストはコードの挙動を忠実に追うことを目的とする
・今、実際に動いている挙動を正解とする
・テストは善悪を裁かず、事実を保存する
・挙動変更は必ず別Issueとする
・最終的な品質判断は実機ログと実運用結果

------------------------------------------------------------
【テスト実装時の実務ルール（補足）】
------------------------------------------------------------

・bats テストでは bin/ 配下での実行前提（cd bin + 相対パス）を再現する
・./xxx.sh の相対実行は PATH ではなく「実ファイル差し替え」でスタブ化する
・スタブは副作用を出さないことを最優先とする
・テスト共通処理は bin/tests/helpers/common.bash に集約する
・過度な抽象化は行わない（追いやすさ優先）

------------------------------------------------------------
【ShellCheck に対する方針】
------------------------------------------------------------

・ShellCheck は重要な静的解析ツールとして活用する
・bats 構文など誤警告と判断できる場合のみ、最小限で抑制する
・テストファイルでは先頭で明示的に指定してよい

例：
  # shellcheck shell=bash
  # shellcheck disable=SC2030,SC2031

・プロダクションコードでは原則として全体無効化は行わない

------------------------------------------------------------
【次の ChatGPT への引き継ぎメモ】
------------------------------------------------------------

・一人称は「私」を使用する
・以前の判断は断絶ではなく連続として扱う
・距離感は「技術的な相棒」
・壊れにくさ・追いやすさを最優先する
・今やるべきでないことは別Issueに分ける

対話ルール：
・説明は対話式・ステップ式
・結果確認前に先読みしない
・流れ：
  次にやること提示 → 実行結果 → 考察 → 次ステップ

------------------------------------------------------------
【補足】
------------------------------------------------------------

この開発ルールと設計思想は、
作者自身が迷わず・疲弊せず・長く付き合うためのもの。

最終的な判断・責任は常に人間が持つ。

dipper はツールである前に、
作者の思考と経験の記録である。
